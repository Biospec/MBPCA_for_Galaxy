<tool id="mbpca" name="Multiblock PCA" version="1.0.0">
  <description>Multiblock models for integrating multiple data sets from different sources or a data set generated by a multiple factor cross-over experiment design</description>
  
  <requirements>
    <requirement type="package">r-batch</requirement>
    <requirement type="package">r-rspectra</requirement>
    <requirement type="package">r-mass</requirement>      
  </requirements>

  <stdio>
    <exit_code range="1:" level="fatal" />
  </stdio>
  
  <command><![CDATA[
  Rscript $__tool_directory__/mbpca_wrapper.R
  dataMatrix_in "$dataMatrix_in"
  instrument "$input.instrument"
  instMetadata_in "$input.instMetadata_in"
  sampleMetadata_in "$sampleMetadata_in"
  model_name "$model_name"
  no_pcs "$no_pcs"
  information "$information"
  file_super "$super_scores"
  file_block "$block_scores"
  file_loadings "$block_loadings"
  file_figures "$figures"
  ]]></command>    
  
  <inputs>
    <param name="dataMatrix_in" type="data" label="Data matrix file" help="" format="csv" />
    <param name="sampleMetadata_in" type="data" label="Sample metadata file" help="" format="csv" />
    <conditional name="input">
        <param name="instrument" type="select" label="Multiple data sources blocking?">
        	<option value="no" selected="true">no</option>
	        <option value="yes">yes</option>
        </param>
	<when value="yes">
		<param name="instMetadata_in" type="data" format="csv" label="Meta data for different data sources" />
    	</when>
	<when value="no">
		<param name="instMetadata_in" type="text" value = "NA" label="Not applicable, ignore this"/>
	</when>
    </conditional>
    <param name="model_name" label="Chose type of multiblock model" type="select" help="">
	  <option value="consensus" selected="true">consensus</option>
	  <option value="hierarchical">hierarchical</option>
    </param>
    <param name="no_pcs" label="The number of Principal Components" type="float" value="2" />	
  </inputs>
  
  <outputs>
    <data name="super_scores" label="${tool.name}_Super_scores.csv" format="tabular" />
    <data name="block_scores" label="${tool.name}_Block_scores.csv" format="tabular" />
    <data name="block_loadings" label = "${tool.name}_Block_loadings.csv" format="tabular" />
    <data name="figures" label="${tool.name}_Figures.pdf" format="pdf"/>
    <data name="information" label="${tool.name}_log.txt" format="txt"/>
  </outputs>

  <tests>
    <test>
      <param name="dataMatrix_in" value="choo_datamatrix.csv"/>
      <param name="sampleMetadata_in" value="meta_exp.csv"/>
      <param name="instrument" value="no" />
      <param name="instMetadata_in" value="NA" /> 
      <param name="no_pcs" value="2" />
      <param name="model_name" value="consensus" />
      <param name="information" value = "Running_log.txt" />
      <param name="file_super" value = "MB_PCA_Super_scores.csv" />
      <param name="file_block" value = "MB_PCA_Block_scores.csv" />
      <param name="file_loadings" value = "MB_PCA_Block_loadings.csv" />
      <param name="file_figures" value = "MB_PCA_Figures.pdf" /> 
    </test>
    <test>
      <param name="dataMatrix_in" value="data_sourceblocking.csv" />
      <param name="sampleMetadata_in" value="meta_sourceblocking_sample.csv" />
      <param name="instrument" value="yes" />
      <param name="instMetadata_in" value="meta_sourceblocking_datasource.csv" />
      <param name="no_pcs" value="2" />
      <param name="model_name" value="consensus" />
      <param name="information" value = "Running_log.txt" />
      <param name="file_super" value = "MB_PCA_Super_scores.csv" />
      <param name="file_block" value = "MB_PCA_Block_scores.csv" />
      <param name="file_loadings" value = "MB_PCA_Block_loadings.csv" />
      <param name="file_figures" value = "MB_PCA_Figures.pdf" />       
    </test>
  </tests>

  
  <help>


========================
Multiblock PCA (MB-PCA)
========================

.. class:: infomark
    
**Authors** Yun Xu (Metaboflow, University of Liverpool) 
    
-----------
Description
-----------
    
| This tool provides mutliblock PCA models which can be used to either "fuse" multiple and related data sets together to provide more information for the modelling (data source blocking) or analyse the data from a balanced multiple factors cross-over experiment design to provide more interpretable results (factor blocking).
|



    
-----------
Input files
-----------
 
+-------------------------------+---------+
| Parameters:                   |  Format |
+===============================+=========+
| 1 : Data matrix file          | csv     |
+-------------------------------+---------+
| 2 : Sample metadata file      | csv     |
+-------------------------------+---------+
| 3 : Data source metadata file | csv/NA  |
+-------------------------------+---------+

|
| For data source blocking, different data matrices shall placed side-by-side, first column shall be unique sample ids, e.g. (1,2,3,...), first row shall be data source labels (e.g. ESI+, ESI-, GC-MS etc) for each variable and saved as a .csv file. In addition, two meta files shall be provided, both in .csv format. One is sample metadata file in which sample labels shall be provided and will be used for labelling data points in the figures; another is data source metadata file in which a column of labels indicating the origin of each variable (e.g. ESI+, ESI-, GC-MS etc) shall be provided and will be used for blocking. To ensure that all the files are to be imported correctly, better manually set "Type" to "csv" instead of "Auto-detect" when using Galaxy "Get Data" tool.
|
| For factor blocking, data source metadata shall be ignored. The data matrix shall be placed as each column is a sample and each row is a variable. The first column shall be a unique description of each variable and will be used to identify PCA loadings; The first row shall be sample labels. The sample meta data shall contain experimental design information, each column is a factor, the header of each column is the name of the factor and the elements below are the names of levels of the samples for this factor. 
|
| Check https://github.com/Biospec/MBPCA_for_Galaxy/tree/master/test-data for examples.
|
|

----------
Parameters
----------
	  
Multiple data sources blocking?
	| "yes" for data source blocking and data source metafile shall be provided, "no" for factor blocking.
	|

Chose type of multiblock model
	| Two MB-PCA models supported: concensus PCA and hierachical PCA, see Westerhuis, J. A. et al. (1998) for details.	
	|	

The number of Principal Components
	| The number of principal components to be extracted, 2 by default. The output figures would always plot PC 1 vs. PC 2, even this parameter is set to be higher than 2. The scores and loadings of all PCs will be saved to the resulting files.
	|

------------
Output files
------------

MB_PCA_Super_scores
	| The super scores of the model.
	|

MB_PCA_Block_scores
	| The block scores of the model.
	|

MB_PCA_loadings
	| The block loadings of the model.
	|

figure.pdf
	| The super and block scores plots. 
	| 

MB_PCA_log.txt
	| Text file with all messages, check if the numbers of samples, variables and blocks match the expectation or any error message if the tool failed to run.
	|
    
  
</help>
  
  <citations>
    <citation type="doi">10.1002/cem.811</citation>
    <citation type="doi">10.1007/s11306-011-0361-9</citation>
    <citation type="doi">10.1002/(SICI)1099-128X(199809/10)12%3A5%3C301%3A%3AAID-CEM515%3E3.0.CO%3B2-S</citation>
  </citations>
  
</tool>
